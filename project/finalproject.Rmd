---
title: "finalproject"
output: html_document
---

```{r}
install.packages('tidycensus')
library(tidycensus)
library(tidyverse)  # For data manipulation and visualization
library(lubridate)  # For handling dates
library(knitr)      # For nice tables
library(scales)     # For better axis formatting
library(sf)
library(tigris)

```



```{r}
pg_crime_2023_2025 <- read_csv("~/Desktop/GitHub/Crime_Incidents_July_2023_to_Present_20250419.csv")
pg_crime_2023_2025_updated <- read_csv("https://raw.githubusercontent.com/dwillis/jour405/refs/heads/main/data/pg_crimes_with_location.csv")
```
```{r}
census_api_key("03183f1d7157fca8529a26898cff8c1b802565ed", overwrite = TRUE)
```

```{r}
view(pg_crime_2023_2025)
```

```{r}
Grouped_by_zip <- pg_crime_2023_2025_updated |>
  filter(!`PGPD Sector` %in% c("FXOS", "SHF", "P10", "FXIN")) |>
  group_by(`PGPD Sector`, zip_code) |>
  summarise(total_crimes = n(), .groups = "drop") |>
  arrange(desc(total_crimes))

```

```{r}
Grouped_data|> 
  summarise(mean_crimes = mean(total), sd_crimes = sd(total))
```
```{r}
ggplot(Grouped_data, aes(x = reorder(`PGPD Sector`, -total), y = total)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = mean(Grouped_data$total), color = 'red', linetype = "dashed", size = 1) +
  geom_hline(yintercept = mean(Grouped_data$total) - sd(Grouped_data$total), color = 'blue', linetype = "dashed", size = 1) +
  geom_hline(yintercept = mean(Grouped_data$total) + sd(Grouped_data$total), color = 'green', linetype = "dashed", size = 1) +
  labs(x = "PGPD Sector", y = "Total Crimes", title = "Total Crimes by PGPD Sector") +
  theme_minimal()
```
```{r}
Grouped_data


# Check the date range in our data
min_crimes <- min(Grouped_data$total)
max_crimes <- max(Grouped_data$total)

```

```{r}
Grouped_data <- Grouped_data |>
  mutate(
    mean_crime = mean(total),
    sd_crime = sd(total),
    z_score = (total - mean_crime) / sd_crime
  )
```
```{r}
# Display the data with z-scores
Grouped_data |>
  select('PGPD Sector', total, z_score) |>
  head(10) 
```

```{r}
Grouped_data <- Grouped_data |>
  mutate(
    z_score = (total - mean(total)) / sd(total),
    z_category = factor(case_when(
      z_score >= 2 ~ "Very High",
      z_score >= .5 ~ "High",
      z_score >= -.5 ~ "Average",
      z_score >= -2 ~ "Low",
      TRUE ~ "Very Low"
    ), levels = c("Very High", "High", "Average", "Low", "Very Low"))
  )
```
```{r}
ggplot(Grouped_data, aes(x = reorder(`PGPD Sector`, -total), y = total, fill =  z_category)) +
  geom_col() +
  scale_fill_manual(values = c(
    "Very High" = "darkred",
    "High" = "orange",
    "Average" = "gray70",
    "Low" = "lightblue",
    "Very Low" = "blue"
  )) +
  labs(
    x = "PGPD Sector",
    y = "Total Crimes",
    fill = "Z-Score Category",
    title = "Crime Totals by PGPD Sector by Z score"
  ) +
  theme_minimal()
```
```{r}
acs_2022_5_year <- load_variables(2022, "acs5", cache = TRUE)

view(acs_2022_5_year)
```
```{r}
income_by_zip <- get_acs(
  geography = "zcta",
  variables = "B19013_001", 
  year = 2022,
  survey = "acs5" )
```

```{r}
glimpse(pg_zcta_shapes)
```


```{r}
zcta_shapes <- zctas(cb = TRUE, year = 2020)

# Get county boundaries for Maryland
md_counties <- counties(state = "MD", cb = TRUE)

# Transform projections to match
zcta_shapes <- st_transform(zcta_shapes, st_crs(md_counties))

# Spatial join to identify ZCTAs overlapping with Prince George's County
pg_zcta_shapes <- st_join(zcta_shapes, md_counties, join = st_intersects) |>
  filter(NAME == "Prince George's") |>
  select(GEOID20) %>%
  distinct()
```
```{r}
pg_income <- income_by_zip %>%
  filter(GEOID %in% pg_zcta_shapes$GEOID20)
```
```{r}
pg_county <- md_counties %>% filter(NAME == "Prince George's")

```



```{r}
pg_income_map <- pg_zcta_shapes %>%
  left_join(income_by_zip, by = c("GEOID20" = "GEOID"))

```


```{r}
ggplot(data = pg_income_map) +
  geom_sf(aes(fill = estimate), color = "white") +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90", name = "Median Income") +
  labs(
    title = "Median Household Income by ZIP Code",
    subtitle = "Prince George's County, MD (ACS 2022)",
    caption = "Source: U.S. Census Bureau, ACS 5-Year Estimates"
  ) +
  theme_minimal()
```
```{r}
zip_crime_counts <- pg_crime_income |>
  group_by(zip_code) |>
  summarise(total_crimes = n(), .groups = "drop")
```
```{r}
pg_crime_income_filtered <- pg_crime_income |>
  left_join(zip_crime_counts, by = "zip_code") |>
  filter(total_crimes.x > 500)
```
```{r}
pg_crime_income_non_filtered <- pg_crime_income |>
  left_join(zip_crime_counts, by = "zip_code") 
```


```{r}
pg_crime_income <- Grouped_by_zip |>
  left_join(pg_income, by = c("zip_code" = "GEOID"))
```
```{r}
#scatterplot to visualize the relationship between median income and crimes all zipcodes)
pg_crime_income_non_filtered |>
  ggplot(aes(x = `estimate`, y = `total_crimes.x`)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(x = "income", y = "total crimes", title = "Scatterplot of total_crimes vs median income")
```

```{r}
#scatterplot to visualize the relationship between median income and crimes (only zip codes with more than 500 total crimes)
pg_crime_income_filtered |>
  ggplot(aes(x = `estimate`, y = `total_crimes.x`)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(x = "income", y = "total crimes", title = "Scatterplot of total_crimes vs median income")
```
```{r}
model <- lm(`total_crimes.x` ~ `estimate`, data = pg_crime_income_filtered) #(only zip codes with more than 500 total crimes)

summary(model)
```
```{r}
model_non <- lm(`total_crimes.x` ~ `estimate`, data = pg_crime_income_non_filtered) #(all zip codes )

summary(model)
```
```{r}
pg_crime_income_filtered$predicted <- predict(model, newdata = pg_crime_income_filtered)

# Calculate the residuals
pg_crime_income_filtered <- pg_crime_income_filtered |> 
  mutate(residual = `total_crimes.x` - predicted)

# Sort the data frame by the absolute value of the residuals in descending order
pg_crime_income_filtered <- pg_crime_income_filtered |>
  mutate(abs_residual = abs(residual)) |>
  arrange(desc(abs_residual))
```

```{r}
pg_crime_income_non_filtered$predicted <- predict(model, newdata = pg_crime_income_non_filtered)

# Calculate the residuals
pg_crime_income_non_filtered <- pg_crime_income_non_filtered |> 
  mutate(residual = `total_crimes.x` - predicted)

# Sort the data frame by the absolute value of the residuals in descending order
pg_crime_income_non_filtered <- pg_crime_income_non_filtered |>
  mutate(abs_residual = abs(residual)) |>
  arrange(desc(abs_residual))
```

Hypothesis: 
If a PGPD Sector Area has more than 4500 crimes in the area, the property value will be lower than if the Reporting Area has less than 3500 crimes





1) What does it contain and what time period does it cover?

The data above includes case_id, date of occurrence, type of crime, and multiple different location indicators. The data spans from Jan 1 2023 to April 19th.

2) Which columns will be most important for your analysis?

I assume the most important data will be one of the location indicator columns, as it will allow me to combine this dataset with the property values to fully compare them. 

3) What's missing that you might need or want? What questions do you have about it or need help answering? 

Something missing that would be super helpful is a map number or a neighborhood name, something easily linked to the property value data. 

I just don't know with this data alone, how I could combine or join the two datasets, or even make sure that we have some uniform way of determining location. 
Something like, does the PGPD reporting code corespond to city district numbers etc. 


My other data set seems to be not exportable..?
this is the link
https://sdat.dat.maryland.gov/RealProperty/Pages/default.aspx

I have been messing around a lot with what to sort by and how to best line it up with the crime data. 

1) What does it contain and what time period does it cover?

When I search, I am using the same timeframe, and using a road that occurs a lot in the crime data. It gives aderress, account number, grantee, housing info, and date sold and selling price. 

2) Which columns will be most important for your analysis?
Once again, some location column may be the most important to link the data to crime, but the sale price is obviously super important as well. 

3) Once again I would love this data to have a more defining piece of location. You can search for neighborhood and by certian codes but doesn't come up on the sheet. 

How do I export this data?



